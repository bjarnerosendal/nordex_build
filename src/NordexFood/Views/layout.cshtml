@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Extensions
@using Umbraco.Cms.Web.Common.Models
@using Microsoft.AspNetCore.Html
@using Microsoft.AspNetCore.Http.Extensions
@using NordexFood.Helpers
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

@{
    
    string siteName = "NordexFood";
    var root = Model.AncestorOrSelf<Site>();
    var SEOFields = Model as ISEO;

    var settings = root?.DescendantsOrSelf<Settings>().FirstOrDefault() as Settings;

    var logoUrl = settings?.SiteLogo?.Url();
    var faviconUrl = settings?.Value<IPublishedContent>("favicon")?.Url();
    var footerText = settings?.Value<string>("footer");
    var searchResultPage = settings?.Value<IPublishedContent>("searchResultPage");
    var canonicalUrl = Model.Value<IPublishedContent>("canonicalUrl")?.Url(mode: UrlMode.Absolute);
    var searchPageUrl = searchResultPage?.Url();
    var MetaTitle = !string.IsNullOrEmpty(SEOFields?.MetaTitle) ? SEOFields.MetaTitle : !string.IsNullOrEmpty(Model?.Name) ? Model?.Name : "";
    
    // Get current culture for html lang attribute - use Umbraco's current culture or fallback to system culture
    var currentCulture = ViewContext.RouteData.Values["culture"]?.ToString() ?? 
                        System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    
    // Get full culture code for data-lang attribute (e.g., "da-DK", "en-US")
    var fullCultureCode = ViewContext.RouteData.Values["culture"]?.ToString() ?? 
                         System.Globalization.CultureInfo.CurrentUICulture.Name;
}

<!DOCTYPE html>
<html lang="@currentCulture" data-lang="@fullCultureCode">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>@MetaTitle @(string.IsNullOrWhiteSpace(MetaTitle) ? "" : "-") @siteName</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    
    @* Favicon *@
    @if (!string.IsNullOrEmpty(faviconUrl))
    {
        <link rel="icon" href="@faviconUrl" type="image/x-icon">
        <link rel="shortcut icon" href="@faviconUrl" type="image/x-icon">
    }

    @* Meta tags for SEO *@
   
        <meta name="description" content="@SEOFields?.MetaDescription">
       @if(!string.IsNullOrEmpty(canonicalUrl))
        {
        <link rel="canonical" href="@canonicalUrl">
        }

    @* Robots meta tag *@
    @{
        var robotsContent = new List<string>();
        if (Model.HasValue("noIndex") && Model.Value<bool>("noIndex"))
        {
            robotsContent.Add("noindex");
        }
        if (Model.HasValue("noFollow") && Model.Value<bool>("noFollow"))
        {
            robotsContent.Add("nofollow");
        }
        
        if (robotsContent.Any())
        {
            <meta name="robots" content="@string.Join(", ", robotsContent)">
        }
    }
    @if (Context.Request.Host.Host == "nordex-food-test.azurewebsites.net")
    {
        <meta name="robots" content="noindex, nofollow">
    }
  
        @* Open Graph meta tags *@
        @if (!string.IsNullOrEmpty(SEOFields?.MetaTitle))
        {
            <meta property="og:title" content="@SEOFields.MetaTitle">
        }
        @if (!string.IsNullOrEmpty(SEOFields?.MetaDescription))
        {
            <meta property="og:description" content="@SEOFields.MetaDescription">
        }
        @if (SEOFields is ISEO seoFieldsWithImage && seoFieldsWithImage.SocialImage is IPublishedContent socialImage && socialImage != null)
        {
        <meta property="og:image" content="@socialImage.GetCropUrl(cropAlias: "ogImage", useCropDimensions: true, furtherOptions: "&format=webp")">
        }
    <meta property="og:type" content="website">
    <meta property="og:url" content="@Context.Request.GetDisplayUrl()">

    @* Bootstrap CSS *@
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    @* Vite Development Assets *@
    @if (Context.Request.Host.Host == "localhost")
    {
        <script type="module" src="http://localhost:5173/@@vite/client"></script>
        <script type="module" src="http://localhost:5173/src/main.ts"></script>
    }
    else
    {
    <!-- Production -->
    {
        var assets = ViteManifestHelper.GetAsset("src/main.ts");

        foreach (var css in assets.CssFiles)
        {
            <link rel="stylesheet" href="@css" />
        }
        <script type="module" src="@assets.JsFile"></script>
    }
    }
    @* Additional head content from child templates *@
    @RenderSection("Head", required: false)
</head>
<body>
    @* Header *@
    @await Html.PartialAsync("_Navigation", (root, settings, searchPageUrl))

    @* Search Overlay *@
    @if (!string.IsNullOrEmpty(searchPageUrl))
    {
        <div class="search-overlay" id="search-overlay" data-search-url="@searchPageUrl">
            <div class="search-overlay-content">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-8 col-xl-6">
                            <form id="header-search-form" role="search">
                                <div class="search-input-group">
                                    <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.35-4.35"></path>
                                    </svg>
                                    <input class="search-input" type="search" placeholder="What are you looking for?" aria-label="Search" id="header-search-input" autocomplete="off">
                                    <button class="search-close" type="button" id="search-close" aria-label="Close search">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                                <div class="search-hint">
                                    Press Enter to search or ESC to close
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Main content area *@
    <main>
        @RenderBody()
      
    </main>

    @* Footer *@
    @if (settings != null)
    {
        @await Html.PartialAsync("_Footer", settings)
    }
    else
    {
        <footer class="bg-light py-4 mt-5">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <p>&copy; @DateTime.Now.Year @siteName. All rights reserved.</p>
                    </div>
                    <div class="col-md-6 text-end">
                        @if (!string.IsNullOrEmpty(footerText))
                        {
                            @Html.Raw(footerText)
                        }
                    </div>
                </div>
            </div>
        </footer>
    }

    @* Vue.js app mount point *@
   
    @* Additional scripts from child templates *@
    @RenderSection("Scripts", required: false)
    @Html.Raw(settings.Value<string>("script"))
</body>
</html>