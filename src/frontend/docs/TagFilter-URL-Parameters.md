# TagFilter Component - URL Query Parameters

## Overview

The TagFilter component now automatically synchronizes search and filter state with URL query parameters, providing:

- **Shareable URLs**: Users can share filtered results via URL
- **Browser Navigation**: Back/forward buttons work correctly
- **Initial State**: URL parameters set initial search/filter values
- **Real-time Updates**: URL updates as users interact with filters

## URL Parameter Structure

The component manages three URL query parameters:

| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `search` | string | Free text search query | `?search=recipe` |
| `tags` | string | Comma-separated list of selected tags | `?tags=vegetarian,easy` |
| `tagQuery` | string | Complex tag group query (Boolean logic) | `?tagQuery=(("tag1" or "tag2") and ("tag3"))` |

## Usage Examples

### 1. Basic Text Search
```
https://example.com/recipes?search=chocolate
```
- Pre-fills search field with "chocolate"
- Automatically triggers search on page load

### 2. Tag Filtering
```
https://example.com/recipes?tags=vegetarian,dessert
```
- Pre-selects "vegetarian" and "dessert" tags
- Shows filtered results on page load

### 3. Combined Search and Filters
```
https://example.com/recipes?search=pasta&tags=italian,quick
```
- Searches for "pasta" in content
- Filters by "italian" and "quick" tags
- Both search and tags applied simultaneously

### 4. Complex Tag Queries
```
https://example.com/recipes?tagQuery=(("vegetarian" or "vegan") and ("quick"))
```
- Uses complex Boolean logic for tag combinations
- Generated by GroupedTagSelector component

## Technical Implementation

### URL Parameter Reading (Initialization)

```typescript
const getUrlParams = () => {
  const urlParams = new URLSearchParams(window.location.search)
  return {
    search: urlParams.get('search') || '',
    tags: urlParams.get('tags') || '',
    tagQuery: urlParams.get('tagQuery') || ''
  }
}

const initializeFromUrlParams = () => {
  isInitializingFromUrl = true
  
  const urlParams = getUrlParams()
  
  // Set initial search query from URL
  if (urlParams.search) {
    searchQuery.value = urlParams.search
  }
  
  // Set initial tags from URL
  if (urlParams.tags) {
    const tagsFromUrl = urlParams.tags.split(',').map(tag => tag.trim()).filter(tag => tag)
    selectedTags.value = tagsFromUrl
  }
  
  // Set initial tag query from URL
  if (urlParams.tagQuery) {
    tagQuery.value = urlParams.tagQuery
  }
  
  // Reset flag after initialization
  setTimeout(() => {
    isInitializingFromUrl = false
  }, 100)
}
```

### URL Parameter Writing (Updates)

```typescript
const updateUrlParams = (search: string, tags: string[], tagQueryParam: string) => {
  // Don't update URL if we're currently initializing from URL params
  if (isInitializingFromUrl) {
    return
  }
  
  if (urlUpdateTimer) {
    clearTimeout(urlUpdateTimer)
  }
  
  urlUpdateTimer = setTimeout(() => {
    const url = new URL(window.location.href)
    const params = url.searchParams
    
    // Update search parameter
    if (search && search.trim()) {
      params.set('search', search.trim())
    } else {
      params.delete('search')
    }
    
    // Update tags parameter
    if (tags.length > 0) {
      params.set('tags', tags.join(','))
    } else {
      params.delete('tags')
    }
    
    // Update tagQuery parameter
    if (tagQueryParam && tagQueryParam.trim()) {
      params.set('tagQuery', tagQueryParam.trim())
    } else {
      params.delete('tagQuery')
    }
    
    // Update URL without page reload
    const newUrl = url.pathname + (params.toString() ? '?' + params.toString() : '')
    window.history.replaceState({}, '', newUrl)
  }, 300) // Debounce URL updates
}
```

### Browser Navigation Support

```typescript
// Listen for browser back/forward navigation
const handlePopState = () => {
  initializeFromUrlParams()
}

window.addEventListener('popstate', handlePopState)
```

## Features

### ✅ **Debounced Updates**
- **Search**: 300ms delay prevents URL spam while typing
- **URL Updates**: 300ms delay for smooth browser experience
- **Performance**: Reduces browser history pollution

### ✅ **State Synchronization**
- **Bidirectional**: URL ↔ Component state stays in sync
- **Real-time**: Changes reflect immediately in URL
- **Consistent**: All filter types supported

### ✅ **Browser Integration**
- **History API**: Uses `replaceState` for smooth updates
- **Back/Forward**: Full browser navigation support
- **Bookmarks**: URLs work as bookmarks and shared links

### ✅ **Edge Case Handling**
- **Initialization Flag**: Prevents infinite loops during URL parsing
- **Empty Values**: Automatically removes empty parameters
- **Invalid Data**: Graceful handling of malformed URLs
- **Multiple Components**: Works with multiple TagFilter instances

## Event Flow

### Page Load with URL Parameters
```
1. Page loads with ?search=pasta&tags=italian
2. initializeFromUrlParams() called
3. searchQuery.value = "pasta"
4. selectedTags.value = ["italian"]
5. ContentResults component receives props
6. API call made with parameters
7. Results displayed
```

### User Interaction
```
1. User types "chocolate" in search field
2. handleSearchQueryChange() called
3. debouncedSearch() triggered (300ms delay)
4. updateUrlParams() called
5. URL updates to ?search=chocolate&tags=italian
6. searchQueryChanged event emitted
7. ContentResults refetches data
```

### Browser Navigation
```
1. User clicks browser back button
2. popstate event fired
3. handlePopState() called
4. initializeFromUrlParams() executed
5. Component state restored from URL
6. ContentResults updates automatically
```

## Integration Points

### With ContentResults Component
```vue
<ContentResults 
  :selected-tags="selectedTags" 
  :tag-query="tagQuery"
  :search-query="searchQuery"
  :page-size="10"
  :language="language"
  :global="global"
  :node-id="nodeId"
  @result-click="handleResultClick"
/>
```

The ContentResults component automatically receives updated props and makes API calls when URL parameters change.

### With API Endpoints
```javascript
// URL: ?search=pasta&tags=italian,quick
// API Call: GET /api/contentsearch?query=pasta&tags=italian,quick&lang=en-US&skip=0&take=10
```

URL parameters map directly to API parameters for consistent behavior.

## Debugging

### Console Debugging
Add this to track URL parameter changes:
```javascript
// Watch URL changes
watch([() => searchQuery.value, () => selectedTags.value, () => tagQuery.value], 
  ([search, tags, query]) => {
    console.log('TagFilter state changed:', { search, tags, query })
    console.log('Current URL:', window.location.href)
  }
)
```

### Browser DevTools
1. **Network Tab**: Monitor API calls triggered by URL changes
2. **Application Tab**: Check session/local storage if needed
3. **Console**: View debug logs for state changes

## Browser Support

- ✅ **Modern Browsers**: Chrome 34+, Firefox 29+, Safari 10+
- ✅ **URL API**: Native URLSearchParams support
- ✅ **History API**: pushState/replaceState support
- ⚠️ **IE11**: Limited support (URLSearchParams polyfill needed)

## Performance Considerations

### Optimizations Implemented
- **Debounced Updates**: Prevents excessive URL modifications
- **Conditional Updates**: Only updates when values actually change
- **Efficient Parsing**: Minimal URL parsing overhead
- **Memory Management**: Proper cleanup of timers and event listeners

### Metrics
- **Search Debounce**: 300ms (balances UX and performance)
- **URL Debounce**: 300ms (prevents browser history spam)
- **Initialization Delay**: 100ms (allows watchers to settle)

## Testing Scenarios

### Manual Testing Checklist
- [ ] **Direct URL**: Load page with `?search=test&tags=tag1,tag2`
- [ ] **Search Input**: Type in search field, verify URL updates
- [ ] **Tag Selection**: Select tags, verify URL updates
- [ ] **Clear Search**: Clear search field, verify URL parameter removed
- [ ] **Browser Back**: Use back button, verify state restored
- [ ] **Browser Forward**: Use forward button, verify state restored
- [ ] **Page Refresh**: Refresh page, verify state maintained
- [ ] **Share URL**: Copy URL, open in new tab, verify same state

### Edge Cases
- [ ] **Empty URL**: Page loads without parameters
- [ ] **Invalid Tags**: URL contains non-existent tag names
- [ ] **Malformed Query**: URL has invalid tagQuery syntax
- [ ] **Special Characters**: Search contains URL-unsafe characters
- [ ] **Multiple Instances**: Multiple TagFilter components on same page

## Migration Notes

### From Non-URL Version
- **Backward Compatible**: Existing functionality unchanged
- **Automatic Enhancement**: URL parameters work immediately
- **No Breaking Changes**: All existing props and events preserved

### Configuration Options
All URL parameter functionality is automatic - no configuration needed. The component intelligently manages URL state based on user interactions.

## Examples in Practice

### Recipe Search Page
```html
<!-- User visits: /recipes?search=chocolate&tags=dessert,easy -->
<!-- Component automatically: -->
<!-- 1. Shows "chocolate" in search field -->
<!-- 2. Selects "dessert" and "easy" tags -->
<!-- 3. Displays filtered results -->
<!-- 4. Updates URL as user modifies filters -->
```

### Blog Article Filtering
```html
<!-- User visits: /blog?tags=technology,tutorial -->
<!-- Component automatically: -->
<!-- 1. Selects "technology" and "tutorial" tags -->
<!-- 2. Shows filtered articles -->
<!-- 3. Maintains state through navigation -->
```

### Complex Product Filtering
```html
<!-- User visits: /products?search=laptop&tagQuery=(("brand:dell" or "brand:hp") and ("price:budget")) -->
<!-- Component automatically: -->
<!-- 1. Shows "laptop" in search field -->
<!-- 2. Applies complex tag logic for brands and price -->
<!-- 3. Updates URL for future filter changes -->
```
